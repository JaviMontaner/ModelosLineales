---
title: "Tarea PF2 - Modelos Lineales"
author: "Alejandro Hernandez Beneito, Javier Montaner de Fez y Salvador Gisbert Sempere"
date: '2023-04-03'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

```{r include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(corrplot)
```

#### 1. Un pequeño resumen.

  En nuestro grupo hemos decidido aplicar los conocimientos que hemos adquirido en la asignatura de Modelos Lineales al dataset "2022-2023 Football Player Stats.csv" extraído https://www.kaggle.com/datasets/vivovinco/20222023-football-player-stats?resource=download .
  
  Es por ello que trabajaremos con el fin último de predecir los máximos goleadores y asistentes de las mejores ligas de fútbol europeas.


#### 2. Introducción.  

  Nuestro dataset original cuenta con 124 variables y +2500 observaciones. Cabe destacar que no trabajaremos con el dataset original sino que  lo haremos con uno con menos variables y observaciones que se acople al nivel del análisis que realizaremos. Para reducirlo hemos tenido en cuenta sólo algunas variables que consideramos son las más influyentes en cuanto a goles y asistencias. 
  
  A medida que hemos avanzado con el preprocesado de los datos, nos hemos dado cuenta de que algunas variables no eran del tipo que les tocaba para poder ser analizadas correctamente. Por ejemplo la variable SoT (Shots on Target) originalmente era de tipo character. Para seguir con nuestro análisis hemos cambiado el tipo de algunas variables.
  
  Otro problema con el que nos hemos encontrado es que algunas variables estaban registradas en variable/partido. Para obtener las variables totales hemos tenido que modificar nuestro dataset.
  
  Por último, hemos eliminado todos aquellos jugadores con menos de 90 minutos jugados, hemos eliminado porteros (no suelen marcar ni asistir y no sería coherente predecir que uno de ellos sea máximo goleador o asistente). Finalmente hemos eliminado jugadores sin goles ni asistencias.
  
  A continuación se muestran los nombres de las variables junto con algunas observaciones para poder tener una idea del dataset con el que trabajaremos:
  
```{r echo=TRUE}
#Cargamos el dataset
futbolistas1 <- read.csv2("2022-2023 Football PLayer Stats.csv", encoding = 'UTF-8')
futbolistas3 <- read.csv2("2021-2022 Football Player Stats.csv", encoding =  'UTF-8')
```

  Para trabajar de manera más cómoda y acorde a nuestros objetivos, modificaremos el dataset:   
  
```{r}
#Comenzamos seleccionando las columnas con las que trabajaremos
futbolistas1 <- futbolistas1[, c("Player","Age","Pos","Min","Goals","Shots","SoT","PasTotCmp","Assists","PasAss")]
futbolistas3 <- futbolistas3[, c("Player","Pos","Age","Min","Goals","Shots","SoT","PasTotCmp","Assists","PasAss")]
futbolistas2 <- data.frame(Player = futbolistas3$Player, Age = futbolistas3$Age, Pos = futbolistas3$Pos, Min = futbolistas3$Min, Goals = futbolistas3$Goals, Shots = futbolistas3$Shots, SoT = futbolistas3$SoT, PasTotCmp = futbolistas3$PasTotCmp, Assists = futbolistas3$Assists, PasAss = futbolistas3$PasAss)
```


```{r echo=TRUE}
#Data Frame FUTBOLISTAS1
#Convertimos cada variable al tipo adecuado para trabajar con ellas de manera correcta
futbolistas1$Assists <- as.numeric(futbolistas1$Assists)
futbolistas1$Min <- as.numeric(futbolistas1$Min)
futbolistas1$Goals <- as.numeric(futbolistas1$Goals)
futbolistas1$Shots <- as.numeric(futbolistas1$Shots)
futbolistas1$SoT <- as.numeric(futbolistas1$SoT)
futbolistas1$PasTotCmp <- as.numeric(futbolistas1$PasTotCmp)
futbolistas1$PasAss <- as.numeric(futbolistas1$PasAss)
futbolistas1$Pos <- as.character(futbolistas1$Pos)
futbolistas1$Pos <- ifelse(nchar(futbolistas1$Pos) > 2, substr(futbolistas1$Pos, 1, 2), futbolistas1$Pos)
futbolistas1$Pos <- as.factor(futbolistas1$Pos)

#Creamos variables en las que recogeremos las estadísticas totales (en nuestro dataset se muestran estadísticas por partidos)
futbolistas1 <- futbolistas1 %>% mutate(Total_Assists = round((futbolistas1$Min/90) * futbolistas1$Assists))
futbolistas1 <- futbolistas1 %>% mutate(Total_Shots = round((futbolistas1$Min/90) * futbolistas1$Shots))
futbolistas1 <- futbolistas1 %>% mutate(Total_SoT = round((futbolistas1$Min/90) * futbolistas1$SoT))
futbolistas1 <- futbolistas1 %>% mutate(Total_Passes = round((futbolistas1$Min/90) * futbolistas1$PasTotCmp))
futbolistas1 <- futbolistas1 %>% mutate(Total_Key_Passes = round((futbolistas1$Min/90) * futbolistas1$PasAss))

#Nos quedamos con las observaciones que cumplan las condiciones (no tiene sentido tener en cuenta jugadores que no han jugado)
futbolistas1 <- futbolistas1 %>% filter(Min >= 90)    %>%
                               filter(Pos != "GK")  %>% 
                               filter(Assists > 0 | Goals > 0)
```

```{r}
#Data Frame FUTBOLISTAS2
#Convertimos cada variable al tipo adecuado para trabajar con ellas de manera correcta
futbolistas2$Assists <- as.numeric(futbolistas2$Assists)
futbolistas2$Min <- as.numeric(futbolistas2$Min)
futbolistas2$Goals <- as.numeric(futbolistas2$Goals)
futbolistas2$Shots <- as.numeric(futbolistas2$Shots)
futbolistas2$SoT <- as.numeric(futbolistas2$SoT)
futbolistas2$PasTotCmp <- as.numeric(futbolistas2$PasTotCmp)
futbolistas2$PasAss <- as.numeric(futbolistas2$PasAss)
futbolistas2$Pos <- as.character(futbolistas2$Pos)
futbolistas2$Pos <- ifelse(nchar(futbolistas2$Pos) > 2, substr(futbolistas2$Pos, 1, 2), futbolistas2$Pos)
futbolistas2$Pos <- as.factor(futbolistas2$Pos)

#Creamos variables en las que recogeremos las estadísticas totales (en nuestro dataset se muestran estadísticas por partidos)
futbolistas2 <- futbolistas2 %>% mutate(Total_Assists = round((futbolistas2$Min/90) * futbolistas2$Assists))
futbolistas2 <- futbolistas2 %>% mutate(Total_Shots = round((futbolistas2$Min/90) * futbolistas2$Shots))
futbolistas2 <- futbolistas2 %>% mutate(Total_SoT = round((futbolistas2$Min/90) * futbolistas2$SoT))
futbolistas2 <- futbolistas2 %>% mutate(Total_Passes = round((futbolistas2$Min/90) * futbolistas2$PasTotCmp))
futbolistas2 <- futbolistas2 %>% mutate(Total_Key_Passes = round((futbolistas2$Min/90) * futbolistas2$PasAss))
futbolistas2 <- futbolistas2 %>% mutate(Goals = round((futbolistas2$Min*futbolistas2$Goals)/90))

#Nos quedamos con las observaciones que cumplan las condiciones (no tiene sentido tener en cuenta jugadores que no han jugado)
futbolistas2 <- futbolistas2 %>% filter(Min >= 90)    %>%
                               filter(Pos != "GK")  %>% 
                               filter(Assists > 0 | Goals > 0)

#Eliminamos el dataframe auxiliar
rm(futbolistas3)
```

```{r}
# Realizamos la fusión de los dataframes
futbolistas3 <- merge(futbolistas1, futbolistas2, by = "Player", all = TRUE)

# Rellenar valores NA en la columna Age con la edad de la otra columna
futbolistas3$Age <- ifelse(is.na(futbolistas3$Age.x), futbolistas3$Age.y, futbolistas3$Age.x)

# Eliminar las columnas Age.x y Age.y
futbolistas3 <- subset(futbolistas3, select = -c(Age.x, Age.y))

# Renombrar la columna Age
colnames(futbolistas3)[colnames(futbolistas3) == "Age"] <- "Age"

#Hacemos lo mismo para la columna Pos
futbolistas3$Pos.x <- as.character(futbolistas3$Pos.x)
futbolistas3$Pos.y <- as.character(futbolistas3$Pos.y)

# Rellenar valores NA en la columna Pos con la posición de la otra columna
futbolistas3$Pos <- ifelse(is.na(futbolistas3$Pos.x), futbolistas3$Pos.y, futbolistas3$Pos.x)

# Eliminar las columnas Pos.x y Pos.y
futbolistas3 <- subset(futbolistas3, select = -c(Pos.x, Pos.y))

# Renombrar la columna Pos
colnames(futbolistas3)[colnames(futbolistas3) == "Pos"] <- "Pos"
futbolistas3$Pos <- as.factor(futbolistas3$Pos)
```

```{r}
#Construimos el dataframe definitivo
futbolistas <- data.frame(Player = futbolistas3$Player)
```


```{r echo=TRUE}
head(futbolistas)
```
  Las variables que contiene nuestro dataset son:
  
  Player: Nombre del futbolista
  Age: Edad del futbolista
  Min: Minutos jugados en total 
  Goals: Goles totales
  Shots: Tiros por partido
  SoT: Tiros a puerta por partido
  PasTotCmp: Pases totales por partido
  Assits: Asistencias por partido
  PasAss: Pases clave por partido
  Total_Assists: Asistencias totales
  Total_Shots: Tiros totales
  Total_SoT: Tiros a puerta totales
  Total_Passes: Pases totales
  Total_Key_Passes: Pases clave totales
  
  
  Ahora, una vez procesado nuestro dataset y ya con los datos adecuados para seguir trabajando, entramos en materia. Veremos como se distribuyen tanto los goles como las asistencias en los jugadores sin importar la posición:
  
  
  
```{r echo=TRUE}
#Separamos a los futbolistas por posición
Defensas <- subset(futbolistas, Pos == "DF")
Centrocampistas <- subset(futbolistas, Pos == "MF")
Delanteros <- subset(futbolistas, Pos == "FW")

#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Goles)
plot(futbolistas$Total_Shots, futbolistas$Goals, col="Blue", main = "Distribución de los goles en función de los tiros realizados", xlab = "Tiros totales", ylab="Goles")
lm_futbolistas <- lm(Goals ~ Total_Shots, data = futbolistas)
coef(lm_futbolistas)
abline(coef = coef(lm_futbolistas), col = "Red")

plot(lm_futbolistas$residuals, main = "Gráfica de residuos en goles", ylab="Residuos")
hist(lm_futbolistas$residuals)


```
  
  Analicemos los modelos que hemos construido. ¿Es un modelo lineal, normal y homocedástico? Vayamos primero con los goles:
  
  La linealidad se define como la relación Y = f(X). Ésta debe ser una recta: $Y = β_0 + β_1X$. Así, podemos afirmar que la relación tiros-goles es lineal (si no tenemos en cuenta los outliers). Las observaciones se distribuyen alrededor de la recta de mínimos cuadrados y los residuos entorno a 0.
  
  Siguiendo con la normalidad, utilizaremos el gráfico de probabilidad-normal paraaceptar esta suposición o rechazarla. Este método muestra los cuantiles de la muestra frente a los cuantiles teóricos. Además añadimos una recta que relaciona de manera ideal ambos cuantiles. Digamos que sería lo "más normal".
```{r}
qqnorm(lm_futbolistas$residuals)
qqline(lm_futbolistas$residuals)
```
  Vemos que nuestros cuantiles se ajustan bastante bien a los teóricos. Podemos afirmar que cumple con la normalidad.
  
  Por último, hablemos de homocedasticidad.
```{r}
# Creamos un gráfico de dispersión de residuos versus valores predichos
plot(lm_futbolistas$residuals, lm_futbolistas$fitted.values, xlab = "Residuos", ylab = "Valores Predichos", main = "Gráfico de dispersión de residuos vs valores predichos")
```
  Podemos observar que la relación entre valores predichos y los residuos sigue una tendencia decreciente. Sabemos que para aceptar la homocedasticidad debería no haber patrones. Por tanto podemos aceptar la heterocedasticidad.
  
  Todo esto con el modelo que relaciona los goles con los tiros. Vayamos ahora a las asistencias frente a los pases totales.
```{r}
#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Asistencias)
plot(futbolistas$Total_Passes,futbolistas$Total_Assists, col="Blue", xlab = "Pases Totales", ylab = "Asistencias", main = "Distribución de las asistencias en función de los pases realizados")
lm_futbolistas <- lm(Total_Assists ~ Total_Passes, data = futbolistas)
coef(lm_futbolistas)
abline(coef = coef(lm_futbolistas), col = "Red")
#Tener en cuenta los pases clave si pertoca

plot(lm_futbolistas$residuals, main = "Gráfica de residuos en asistencias", ylab = "Residuos")
hist(lm_futbolistas$residuals)
``` 
  Con respecto a la linealidad no podemos asegurar que lo sea, pues no sólo no se distribuyen los datos en forma de recta sino que además los residuos no se distribuyen exactamente entorno al 0 sino que está un poco desplazado.
  
  Analicemos ahora la normalidad siguiendo el mismo procedimiento que antes:
```{r}
qqnorm(lm_futbolistas$residuals)
qqline(lm_futbolistas$residuals)
```
  Vemos que no cumple con la normalidad.
  
  Por último, vayamos con la homocedasticidad:
```{r}
# Creamos un gráfico de dispersión de residuos versus valores predichos
plot(lm_futbolistas$residuals, lm_futbolistas$fitted.values, xlab = "Residuos", ylab = "Valores Predichos", main = "Gráfico de dispersión vs. valores predichos")
```
 Podemos decir que no cumple con la homocedasticidad pues siguen una tendencia descendente. Por tanto aceptamos la heterocedasticidad.
  
  
  Hagamos lo mismo ahora pero para cada posición. ¿Afectará la posición a la distribución de los goles? ¿Y de las asistencias?

```{r}
#Comenzamos con los DEFENSAS
#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Goles)
plot(Defensas$Total_Shots, Defensas$Goals, col="Blue", main = "Goles en función de los tiros realizados en defensas")
lm_defensas <- lm(Goals ~ Total_Shots, data = Defensas)
coef(lm_defensas)
abline(coef = coef(lm_defensas), col = "Red")

#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Asistencias)
plot(Defensas$Total_Passes,Defensas$Total_Assists, col="Blue", xlab = "Pases Totales", ylab = "Asistencias", main = "Asistencias en función de los pases realizados en defensas")
lm_defensas <- lm(Total_Assists ~ Total_Passes, data = Defensas)
coef(lm_defensas)
abline(coef = coef(lm_defensas), col = "Red")
#Tener en cuenta los pases clave si pertoca
```


```{r}
#Comenzamos con los CENTROCAMPISTAS
#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Goles)
plot(Centrocampistas$Total_Shots, Centrocampistas$Goals, col="Blue", main = "Goles en función de los tiros realizados en centrocampistas", xlab = "Tiros totales", ylab = "Goles")
lm_centrocampistas <- lm(Goals ~ Total_Shots, data = Centrocampistas)
coef(lm_centrocampistas)
abline(coef = coef(lm_centrocampistas), col = "Red")

#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Asistencias)
plot(Centrocampistas$Total_Passes,Centrocampistas$Total_Assists, col="Blue", xlab = "Pases Totales", ylab = "Asistencias", main = "Asistencias en función de los pases realizados en centrocampistas")
lm_centrocampistas <- lm(Total_Assists ~ Total_Passes, data = Centrocampistas)
coef(lm_centrocampistas)
abline(coef = coef(lm_centrocampistas), col = "Red")
#Tener en cuenta los pases clave si pertoca
```

```{r}
#Comenzamos con los DELANTEROS
#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Goles)
plot(Delanteros$Total_Shots, Delanteros$Goals, col="Blue", main = "Goles en función de los tiros realizados en delanteros", xlab = "Tiros totales", ylab = "Goles")
lm_delanteros <- lm(Goals ~ Total_Shots, data = Delanteros)
coef(lm_delanteros)
abline(coef = coef(lm_delanteros), col = "Red")

#Construimos la nube de puntos junto con la recta de mínimos cuadrados (Asistencias)
plot(Delanteros$Total_Passes,Delanteros$Total_Assists, col="Blue", xlab = "Pases Totales", ylab = "Asistencias", main = "Asistencias en función de los pases realizados en delanteros")
lm_delanteros <- lm(Total_Assists ~ Total_Passes, data = Delanteros)
coef(lm_delanteros)
abline(coef = coef(lm_delanteros), col = "Red")
#Tener en cuenta los pases clave si pertoca
```
  Para empezar a modelar en función de nuestro objetivo, veamos las correlaciones entre las distintas variables:
```{r}
#Gráfico de las correlaciones
futbolistas_cor <- futbolistas[4:15]
corrplot(cor(futbolistas_cor))
```
  Con este gráfico podemos observar la correlación que existe con cada variable. Vemos que para predecir goles tendría sentido tomar en cuenta los, los tiros y los tiros a portería. En cuanto a las asistencias vemos que están muy relacionadas con los pases clave.

  Empecemos a construir el modelo que predecirán nuestras variables. Para predecir los goles:

```{r}
#Primero comenzaremos tomando todas las variables 
modelo_goles1 <- lm(Goals ~ ., data = futbolistas)

#Con la ayuda de la herramienta step, obtendremos el modelo que mejor predice la variable que nos interesa:
modelo_goles <- step(modelo_goles1)
```

  Hagamos lo mismo con las asistencias:
  
```{r}
#Primero comenzaremos tomando todas las variables 
modelo_asistencias1 <- lm(Total_Assists ~ ., data = futbolistas)

#Con la ayuda de la herramienta step, obtendremos el modelo que mejor predice la variable que nos interesa:
modelo_asistencias <- step(modelo_asistencias1)
```


```{r}
# Obtener predicciones del modelo de goles
predicciones_goles <- predict(modelo_goles)

# Crear un nuevo dataframe con los nombres de los futbolistas y las predicciones de goles
resultado <- data.frame(Nombre = futbolistas$Player, Goles_Predichos = round(predicciones_goles))

# Ordenar el dataframe por el número de goles predichos en orden descendente
resultado <- resultado[order(resultado$Goles_Predichos, decreasing = TRUE), ]

# Imprimir el resultado ordenado
print(resultado)

```

```{r}
# Obtenemos predicciones del modelo de asistencias
predicciones_asistencias <- predict(modelo_asistencias)

# Crear un nuevo dataframe con los nombres de los futbolistas y las predicciones de goles
resultado <- data.frame(Nombre = futbolistas$Player, Asistencias_Predichas = round(predicciones_asistencias))

# Ordenar el dataframe por el número de goles predichos en orden descendente
resultado <- resultado[order(resultado$Asistencias_Predichas, decreasing = TRUE), ]

# Imprimir el resultado ordenado
print(resultado)
```



```{r echo=TRUE}
modelo <- lm(Goals ~ Age + Pos + Min + Total_Shots + Total_SoT , data = futbolistas)
step(modelo)


modelo1 <- lm(Assists ~ Age + Pos + Min + Total_Assists +Total_Passes + Total_Key_Passes , data = futbolistas)
step(modelo1)
summary(modelo1)

```

